name: Prover e2e test

on:
  workflow_dispatch:
  push:
    branches: [ "main", "develop", "release_*" ]
  pull_request:
    branches: [ "main", "develop", "release_*" ]

jobs:
  e2e-collection-tests:

    runs-on: [self-hosted, linux, X64, hc, hm]

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: 'true'
    - uses: actions/setup-node@v2
      with:
        node-version: '16'
    - name: Install snarkjs
      run: npm list -g snarkjs || npm -g install snarkjs
    - name: make
      run: cd src/grpc && make && cd ../.. && make PROVER_FORK_ID=10 generate && make PROVER_FORK_ID=10 -j
    - name: remove all config 
      run: rm -rf config
    - name: remove old proofs
      run: rm -rf runtime/output/*
    - name: list gha config files
      run: ls /home/gha/v7.0.0-rc.14-fork.10/config/
    - name: link files
      run: ln -s /home/gha/v7.0.0-rc.14-fork.10/config/ config
    - name: list local config files
      run: ls config
    - name: run collection native tests
      run: ./build/zkProver -c testvectors/config_collection_native.json
    - name: run collection generated tests
      run: ./build/zkProver -c testvectors/config_collection_generated.json
    - name: run e2e tests
      run: ./build/zkProver -c testvectors/config_runFile_e2e.json 
    - name: run snarkjs verification
      run: snarkjs ffv config/final/final.fflonk.verkey.json $(ls -t runtime/output/*.gen_final_proof_public.json | head -n1) $(ls -t runtime/output/*.final_proof.proof.json | head -n1)
    - name: clean
      run: make clean
    - name: make 11
      run: cd src/grpc && make && cd ../.. && make PROVER_FORK_ID=11 generate && make PROVER_FORK_ID=11 -j
    - name: remove all config 11
      run: rm -rf config
    - name: remove old proofs 11
      run: rm -rf runtime/output/*
    - name: list gha config files 11
      run: ls /home/gha/v7.0.0-rc.14-fork.11/config/
    - name: link files 11
      run: ln -s /home/gha/v7.0.0-rc.14-fork.11/config/ config
    - name: list local config files 11
      run: ls config
    - name: run collection native tests 11
      run: ./build/zkProver -c testvectors/config_collection_native.json
    - name: run collection generated tests 11
      run: ./build/zkProver -c testvectors/config_collection_generated.json
    - name: run e2e tests 11
      run: ./build/zkProver -c testvectors/config_runFile_e2e.json 
    - name: run snarkjs verification 11
      run: snarkjs ffv config/final/final.fflonk.verkey.json $(ls -t runtime/output/*.gen_final_proof_public.json | head -n1) $(ls -t runtime/output/*.final_proof.proof.json | head -n1)
